import * as fs from 'fs';
import * as path from 'path';

/**
 * Script to generate deparser index files for each version
 * Creates index.ts files that use transformers to provide deparse functionality
 */

interface VersionConfig {
  version: number;
  directTransformerClass: string;
  directTransformerFile: string;
}

const VERSIONS_DIR = 'versions';

const versionConfigs: VersionConfig[] = [
  {
    version: 13,
    directTransformerClass: 'PG13ToPG17Transformer',
    directTransformerFile: './v13-to-v17-direct'
  },
  {
    version: 14,
    directTransformerClass: 'PG14ToPG17Transformer',
    directTransformerFile: './v14-to-v17-direct'
  },
  {
    version: 15,
    directTransformerClass: 'PG15ToPG17Transformer',
    directTransformerFile: './v15-to-v17-direct'
  },
  {
    version: 16,
    directTransformerClass: 'PG16ToPG17Transformer',
    directTransformerFile: './v16-to-v17-direct'
  }
];

function generateDeparserIndex(config: VersionConfig): string {
  return `/**
 * Deparser for PostgreSQL version ${config.version}
 * Auto-generated by generate-version-deparsers.ts
 */

import { Node, ParseResult } from '@pgsql/types';
import { 
  deparse as deparse17, 
  deparseSync as deparseSync17,
  DeparserOptions 
} from './deparser';
import { ${config.directTransformerClass} } from '${config.directTransformerFile}';

const tx = new ${config.directTransformerClass}();

export async function deparse(query: Node | Node[] | ParseResult, opts?: DeparserOptions): Promise<string> {
  const ast17 = tx.transform(query);
  return await deparse17(ast17, opts);
}

export function deparseSync(query: Node | Node[] | ParseResult, opts?: DeparserOptions): string {
  const ast17 = tx.transform(query);
  return deparseSync17(ast17, opts);
}

// Re-export DeparserOptions for convenience
export { DeparserOptions } from './deparser';
`;
}

function updateVersionDirectory(config: VersionConfig): void {
  const versionDir = path.join(VERSIONS_DIR, config.version.toString());
  
  if (!fs.existsSync(versionDir)) {
    console.error(`Version directory ${versionDir} does not exist!`);
    return;
  }

  // Create src directory if it doesn't exist
  const srcDir = path.join(versionDir, 'src');
  if (!fs.existsSync(srcDir)) {
    fs.mkdirSync(srcDir, { recursive: true });
  }

  // Remove old index.js if it exists
  const oldIndexPath = path.join(srcDir, 'index.js');
  if (fs.existsSync(oldIndexPath)) {
    fs.unlinkSync(oldIndexPath);
    console.log(`  ✓ Removed old index.js`);
  }

  // Generate new index.ts in src directory
  const indexContent = generateDeparserIndex(config);
  const indexPath = path.join(srcDir, 'index.ts');
  fs.writeFileSync(indexPath, indexContent);
  console.log(`  ✓ Created index.ts with deparser functionality`);
}



function main(): void {
  console.log('Generating version-specific deparsers...\n');

  for (const config of versionConfigs) {
    console.log(`Processing version ${config.version}...`);
    updateVersionDirectory(config);

    console.log('');
  }

  console.log('Done! Version-specific deparsers have been generated.');
}

// Run the script
main();